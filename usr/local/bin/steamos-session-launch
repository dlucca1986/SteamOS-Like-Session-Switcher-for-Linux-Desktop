#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Gamescope Session Launcher
# =============================================================================
# Path: /usr/local/bin/steamos-session-launch
# =============================================================================

# --- 1. Safe Mode Defaults (The "Parachute") ---
TARGET_WIDTH=1920
TARGET_HEIGHT=1080
REFRESH_RATE=60
ENABLE_HDR=0
ENABLE_VRR=0
ENABLE_MANGOAPP=1
CUSTOM_ARGS=""

# --- 2. Configuration & Status Logic ---
USER_CONFIG="$HOME/.config/steamos-diy/config"
CONFIG_STATUS="SAFE MODE (1080p@60Hz)"

if [ -f "$USER_CONFIG" ]; then
    if source "$USER_CONFIG" 2>/dev/null; then
        CONFIG_STATUS="CUSTOM (User settings applied)"
        [[ -n "$CUSTOM_ARGS" ]] && CONFIG_STATUS="POWER USER (Custom Args Injected)"
    else
        CONFIG_STATUS="ERROR (Syntax error in config! Falling back to SAFE MODE)"
    fi
fi

# --- 3. Environment & Logging ---
readonly LOG_FILE="/tmp/gamescope-session.log"
exec > "$LOG_FILE" 2>&1

echo "[$(date '+%Y-%m-%d %H:%M:%S')] Session Initiation"
echo "Targeting: $CONFIG_STATUS"

export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope
export GAMEMODE_AUTO=1
export STEAM_USE_MANGOAPP=1
export STEAM_MULTIPLE_XWAYLANDS=1

# --- 4. Hardware Awareness (Fix for Mini-Laptops/Small Screens) ---
HW_MAX_RES=$(cat /sys/class/drm/*/modes 2>/dev/null | head -n 1)
if [[ -n "$HW_MAX_RES" ]]; then
    HW_W=$(echo $HW_MAX_RES | cut -d'x' -f1)
    HW_H=$(echo $HW_MAX_RES | cut -d'x' -f2)
    
    if [ "$TARGET_WIDTH" -gt "$HW_W" ] || [ "$TARGET_HEIGHT" -gt "$HW_H" ]; then
        echo "[WARN] Requested ${TARGET_WIDTH}x${TARGET_HEIGHT} exceeds hardware ($HW_W$x$HW_H). Adjusting."
        TARGET_WIDTH=$HW_W
        TARGET_HEIGHT=$HW_H
    fi
fi

# --- 5. Argument Scrubbing Logic (ScopeBuddy Inspired) ---
# This cleans CUSTOM_ARGS from redundant or breaking flags
clean_custom_args() {
    local raw_args=($CUSTOM_ARGS)
    local cleaned=()
    for arg in "${raw_args[@]}"; do
        # Ignore -e and --steam as they are handled by the final execution line
        # and would cause crashes if duplicated in standalone mode.
        if [[ "$arg" == "-e" ]] || [[ "$arg" == "--steam" ]]; then
            echo "[INFO] Scrubbing redundant/broken flag from CUSTOM_ARGS: $arg" >&2
            continue
        fi
        cleaned+=("$arg")
    done
    echo "${cleaned[@]}"
}

# --- 6. Build Final Command ---
build_args() {
    local SCRUBBED_CUSTOM=$(clean_custom_args)
    
    ARGS=(
        --output-width "$TARGET_WIDTH"
        --output-height "$TARGET_HEIGHT"
        --refresh "$REFRESH_RATE"
        --always-epl
        --hide-cursor-delay 3000
    )
    
    [[ $ENABLE_HDR -eq 1 ]]      && ARGS+=(--hdr-enabled)
    [[ $ENABLE_VRR -eq 1 ]]      && ARGS+=(--adaptive-sync)
    [[ $ENABLE_MANGOAPP -eq 1 ]] && ARGS+=(--mangoapp)
    
    if [[ -n "$SCRUBBED_CUSTOM" ]]; then
        read -a INJECTED_ARGS <<< "$SCRUBBED_CUSTOM"
        ARGS+=("${INJECTED_ARGS[@]}")
    fi
    echo "${ARGS[@]}"
}

# --- 7. Execution & Watchdog ---
read -a FINAL_ARGS <<< "$(build_args)"
echo "Final Parameters: ${TARGET_WIDTH}x${TARGET_HEIGHT}@${REFRESH_RATE}Hz"

# Launch in background to monitor health
gamescope "${FINAL_ARGS[@]}" -e -- steam -steamdeck -steamos -steamos3 &
GAMESCOPE_PID=$!

# Wait 3 seconds to ensure the display driver hasn't crashed
sleep 3

if ! kill -0 $GAMESCOPE_PID 2>/dev/null; then
    echo "[CRITICAL] Session crashed! Reverting to Safe Mode..."
    # Rename corrupted config to prevent boot-loops
    [[ -f "$USER_CONFIG" ]] && mv "$USER_CONFIG" "${USER_CONFIG}.broken"
    
    # Emergency Launch (Safe Defaults - 720p is universal)
    exec gamescope --output-width 1280 --output-height 720 --refresh 60 -e -- \
        steam -steamdeck -steamos -steamos3
fi

wait $GAMESCOPE_PID

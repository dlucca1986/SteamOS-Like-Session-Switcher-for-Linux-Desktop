#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Universal Gamescope Session Launcher
# =============================================================================
# Path: /usr/local/bin/steamos-session-launch
# Description: Ultra-robust core launcher with "Safe Mode" and minimal dependencies.
# =============================================================================

# --- 1. Safe Mode Defaults ---
TARGET_WIDTH=1920
TARGET_HEIGHT=1080
REFRESH_RATE=60
ENABLE_MANGOAPP=1
CUSTOM_ARGS=""

# --- 2. User Configuration Loading ---
USER_CONFIG="$HOME/.config/steamos-diy/config"
CONFIG_STATUS="SAFE MODE"

if [ -f "$USER_CONFIG" ]; then
    if source "$USER_CONFIG" 2>/dev/null; then
        CONFIG_STATUS="CUSTOM (User settings applied)"
    else
        CONFIG_STATUS="ERROR (Syntax error in config! Falling back to SAFE MODE)"
    fi
fi

# --- 3. Environment & Logging ---
readonly LOG_FILE="/tmp/steamos-diy.log"
exec > "$LOG_FILE" 2>&1

echo "[$(date '+%Y-%m-%d %H:%M:%S')] [Launcher] Initiating session: $CONFIG_STATUS"

# Standard SteamOS Environment Variables
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=gamescope
export STEAM_USE_MANGOAPP=1
export STEAM_MULTIPLE_XWAYLANDS=1

# Failsafe Gamemode activation via environment variable instead of wrapper
export GAMEMODE_AUTO=1

# Essential Intel/Integrated GPU Stability fix
export WBC_DISABLE_MODIFIERS=1 

# --- 4. Hardware Awareness ---
HW_MAX_RES=$(cat /sys/class/drm/*/modes 2>/dev/null | head -n 1)
if [[ -n "$HW_MAX_RES" ]]; then
    HW_W=$(echo $HW_MAX_RES | cut -d'x' -f1)
    HW_H=$(echo $HW_MAX_RES | cut -d'x' -f2)
    if [ "$TARGET_WIDTH" -gt "$HW_W" ] || [ "$TARGET_HEIGHT" -gt "$HW_H" ]; then
        echo "[WARN] Resolution adjustment: ${TARGET_WIDTH}x${TARGET_HEIGHT} -> ${HW_W}x${HW_H}"
        TARGET_WIDTH=$HW_W
        TARGET_HEIGHT=$HW_H
    fi
fi

# --- 5. Argument Build Logic ---
build_args() {
    # Core stability flags
    ARGS=(
        --output-width "$TARGET_WIDTH"
        --output-height "$TARGET_HEIGHT"
        --refresh "$REFRESH_RATE"
        --always-epl
        --disable-modifiers
        --hide-cursor-delay 3000
        --fade-out-duration 200
        -e
    )

    [[ $ENABLE_MANGOAPP -eq 1 ]] && ARGS+=(--mangoapp)
    
    # User custom arguments from config file
    if [[ -n "$CUSTOM_ARGS" ]]; then
        # Scrubbing redundant flags
        local CLEANED_ARGS=$(echo "$CUSTOM_ARGS" | sed 's/-e//g; s/--steam//g')
        read -a INJ <<< "$CLEANED_ARGS"
        ARGS+=("${INJ[@]}")
    fi
    echo "${ARGS[@]}"
}

# --- 6. Execution & Watchdog ---
read -a FINAL_ARGS <<< "$(build_args)"
echo "[Launcher] Final Parameters: ${TARGET_WIDTH}x${TARGET_HEIGHT}@${REFRESH_RATE}Hz"

# Launch Gamescope directly (letting GAMEMODE_AUTO handle the rest)
gamescope "${FINAL_ARGS[@]}" -- steam -steamos -gamepadui -steamdeck &
GAMESCOPE_PID=$!

sleep 5 # Monitoring window for startup stability

if ! kill -0 $GAMESCOPE_PID 2>/dev/null; then
    echo "[CRITICAL] Startup failed! Triggering Naked Recovery..."
    
    # Isolate potentially broken user config
    [[ -f "$USER_CONFIG" ]] && mv "$USER_CONFIG" "${USER_CONFIG}.broken"
    
    # --- Naked Recovery ---
    # Purest form: no gamemoderun, no custom args, no complex logic.
    echo "[INFO] Emergency Fallback: Native Resolution, Safe Flags Only"
    exec gamescope --disable-modifiers --always-epl -e -n -- steam -steamdeck -steamos3
fi

wait $GAMESCOPE_PID

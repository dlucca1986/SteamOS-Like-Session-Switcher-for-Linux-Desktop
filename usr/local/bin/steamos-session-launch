#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Intelligent Universal Launcher
# =============================================================================
# Version: 3.0.0
# Description: Fail-safe launcher with Atomic Watchdog and hardware diagnostics.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/steamos-session-launch
# License: MIT
# =============================================================================

set -eou pipefail

# 1. Path Configuration
readonly LOG_FILE="/var/log/steamos-diy.log"
readonly CONFIG_DIR="$HOME/.config/steamos-diy"
readonly CONFIG_FILE="$CONFIG_DIR/config"

# Logging Function: Writes and ensures open permissions for the Control Center
log_msg() {
    local level="$1"
    local msg="$2"
    # Write to log. Silence errors if the file is temporarily locked or inaccessible.
    echo "[$level] $(date '+%Y-%m-%d %H:%M:%S') - $msg" >> "$LOG_FILE" 2>/dev/null || true
    chmod 666 "$LOG_FILE" 2>/dev/null || true
}

# --- Hardware Diagnostics ---
trace_gpu_failure() {
    log_msg "DEBUG" "--- GPU FAILURE DIAGNOSTIC ---"
    log_msg "DEBUG" "DRM Master Status: $(ls /sys/class/drm/card*/device/drm/card*/master 2>/dev/null || echo 'None found')"
    log_msg "DEBUG" "Processes using GPU: $(fuser -v /dev/dri/card* 2>&1 || echo 'None')"
}

# 2. Safe Mode Management
SAFE_MODE=false
[[ "${1:-}" == "--safe-mode" ]] && SAFE_MODE=true

if [ "$SAFE_MODE" = true ]; then
    log_msg "ERROR" "SAFE MODE ACTIVE - Attempting recovery with autoconfig"
    trace_gpu_failure
else
    log_msg "INFO" "Starting standard Gaming Session"
fi

# 3. Configuration Generation/Loading
# If config is missing, attempt to auto-detect from connected monitors
if [[ ! -f "$CONFIG_FILE" ]]; then
    mkdir -p "$CONFIG_DIR"
    ACTIVE_PATH=$(grep -l "^connected" /sys/class/drm/card*-*/status | head -n1 || true)

    if [[ -n "$ACTIVE_PATH" ]]; then
        ACTIVE_DIR=$(dirname "$ACTIVE_PATH")
        _RES=$(head -n1 "$ACTIVE_DIR/modes" 2>/dev/null || echo "1280x720")
        _W=$(echo "$_RES" | cut -d'x' -f1)
        _H=$(echo "$_RES" | cut -d'x' -f2)
    else
        _W=1280; _H=720
    fi
    # Create default user config
    echo -e "TARGET_WIDTH=$_W\nTARGET_HEIGHT=$_H\nREFRESH_RATE=60" > "$CONFIG_FILE"
    log_msg "CONFIG" "No config found. Auto-detected: ${_W}x${_H}"
fi

# Load variables with safety fallbacks
source "$CONFIG_FILE" 2>/dev/null || true
W=${TARGET_WIDTH:-1280}
H=${TARGET_HEIGHT:-720}
R=${REFRESH_RATE:-60}

G_ARGS=("-e" "-W" "$W" "-H" "$H" "-r" "$R")

# 4. Execution and Watchdog
log_msg "LAUNCH" "Gamescope arguments: ${G_ARGS[*]}"
START=$(date +%s)

# Launch Steam under Gamescope
# Using stdbuf to prevent logging delays for the Python GUI
stdbuf -oL -eL gamescope "${G_ARGS[@]}" -- steam -steamdeck -steamos3 $([ "$SAFE_MODE" = true ] && echo "-autoconfig") >> "$LOG_FILE" 2>&1 || true

# Ensure the log remains accessible after crash/closure
chmod 666 "$LOG_FILE" 2>/dev/null || true

# Watchdog: if the session lasts less than 2 seconds, it is considered a critical crash
if [ "$SAFE_MODE" = false ] && [ $(( $(date +%s) - START )) -lt 2 ]; then
    log_msg "CRITICAL" "Session lasted < 2s. Relaunching in Safe Mode..."
    trace_gpu_failure
    exec "$0" --safe-mode
fi

log_msg "SUCCESS" "Session terminated gracefully"
exit 0

#!/bin/bash
# =============================================================================
# SteamMachine-DIY - SDDM State Helper (set-sddm-session)
# =============================================================================
# Version: 2.3.0
# Description: Privileged helper with ANSI styling and atomic operations.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/set-sddm-session
# License: MIT
# =============================================================================

set -eou pipefail

# --- ANSI Colors ---
RED='\033[1;31m'
GREEN='\033[1;32m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
BOLD='\033[1m'
NC='\033[0m'

# --- Configuration ---
readonly SDDM_CONF_DIR="/etc/sddm.conf.d"
readonly SDDM_CONF_FILE="${SDDM_CONF_DIR}/zz-steamos-autologin.conf"
readonly LOG_FILE="/tmp/steamos-diy.log"

# Input Arguments
readonly SESSION_NAME=$(basename "${1:-steamos-switcher}" .desktop)
readonly USER_NAME="${2:-}"

# --- Logging System ---
log_helper() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local color=$NC

    case "$level" in
        "INFO")    color=$CYAN ;;
        "SUCCESS") color=$GREEN ;;
        "ERROR")   color=$RED ;;
    esac

    # Output a terminale solo se interattivo
    if [[ -t 1 ]]; then
        echo -e "${MAGENTA}${BOLD}[HELPER]${NC} ${color}${message}${NC}"
    fi

    echo "[$timestamp] [HELPER-$level] $message" >> "$LOG_FILE" 2>/dev/null || true
    logger -t SteamMachine-DIY "[HELPER-$level] $message"
}

# --- Validation ---
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}${BOLD}CRITICAL ERROR:${NC} Must be run as root"
    exit 1
fi

if [[ -z "$USER_NAME" ]]; then
    log_helper "ERROR" "No target username provided."
    exit 1
fi

# --- Atomic Configuration Write ---
log_helper "INFO" "Updating SDDM for $USER_NAME (Session: $SESSION_NAME)"

mkdir -p "$SDDM_CONF_DIR"

TMP_FILE=$(mktemp)
cat <<EOF > "$TMP_FILE"
[Autologin]
User=$USER_NAME
Session=$SESSION_NAME
Relogin=false
EOF

if mv "$TMP_FILE" "$SDDM_CONF_FILE"; then
    chmod 644 "$SDDM_CONF_FILE"
    log_helper "SUCCESS" "SDDM Configuration applied."
else
    rm -f "$TMP_FILE"
    log_helper "ERROR" "Failed to update configuration."
    exit 1
fi

#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Privileged Helper (set-sddm-session)
# =============================================================================
# Version: 3.0.0
# Description: Handles system-level session switching and hardware cleanup
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path: /usr/local/bin/set-sddm-session
# License: MIT
# =============================================================================

set -euo pipefail

# 1. Argument Retrieval (Consistent with os-session-select)
readonly SESSION_NAME=$(basename "${1:-steamos-switcher}" .desktop)
readonly TARGET_USER="${2:-}"
readonly LOG_FILE="${3:-/var/log/steamos-diy.log}"
readonly SDDM_CONF_DIR="/etc/sddm.conf.d"
readonly AUTOLOGIN_FILE="$SDDM_CONF_DIR/zz-steamos-autologin.conf"

# Logging Function: Writes and unlocks permissions for the Control Center
log_msg() {
    local level="$1"
    local msg="$2"
    echo "[$level] $(date '+%Y-%m-%d %H:%M:%S') - $msg" >> "$LOG_FILE" 2>/dev/null || true
    chmod 666 "$LOG_FILE" 2>/dev/null || true
}

# Verify root privileges
if [[ $EUID -ne 0 ]]; then
   log_msg "ERROR" "Execution requires root privileges"
   exit 1
fi

# 2. Update SDDM Configuration
if [[ -n "$TARGET_USER" ]]; then
    mkdir -p "$SDDM_CONF_DIR"
    # Clean write of the autologin file
    printf "[Autologin]\nUser=%s\nSession=%s\nRelogin=false\n" "$TARGET_USER" "$SESSION_NAME" > "$AUTOLOGIN_FILE"
    sync
    log_msg "CONFIG" "SDDM autologin set to $SESSION_NAME for $TARGET_USER"
fi

# 3. Detach execution with Systemd-Run
# We use systemd-run to prevent the session termination from killing this script
systemd-run --unit=session-switcher-task --scope bash -c "
    # Internal logging function for the systemd scope
    log_sh() {
        echo \"[\$1] \$(date '+%Y-%m-%d %H:%M:%S') - \$2\" >> '$LOG_FILE'
        chmod 666 '$LOG_FILE' 2>/dev/null || true
    }

    log_sh 'INFO' 'Stopping SDDM and cleaning up hardware hooks...'
    systemctl stop sddm

    # KMS Cleanup: Release the GPU
    if fuser /dev/dri/card* >/dev/null 2>&1; then
        fuser -k -9 /dev/dri/card* >/dev/null 2>&1 || true
    fi

    # Terminate orphan interface processes
    pkill -9 -u '$TARGET_USER' kwin_wayland || true
    pkill -9 -u '$TARGET_USER' Xwayland || true
    pkill -9 -u '$TARGET_USER' gamescope || true
    pkill -9 -u '$TARGET_USER' steam || true

    sleep 0.5

    # Rebind Virtual Terminal (VT) - Essential to avoid black screens
    for vtc in /sys/class/vtconsole/vtcon*/bind; do
        if [ -f \"\$vtc\" ]; then
            echo 1 > \"\$vtc\" 2>/dev/null || true
        fi
    done

    log_sh 'INFO' 'Restarting SDDM...'
    systemctl start sddm
    log_sh 'SUCCESS' 'Session switch finished'
" &

exit 0

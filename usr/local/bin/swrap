#!/bin/bash

# --- CONFIGURAZIONE ---
CONF_DIR="$HOME/.config/swrap/games"
GLOBAL_CONF="$CONF_DIR/global.conf"
DEBUG_LOG="/tmp/swrap.log"

mkdir -p "$CONF_DIR"

# 1. CREAZIONE GLOBAL.CONF (Ottimizzazioni fisse Hardware RDNA 2)
if [ ! -f "$GLOBAL_CONF" ]; then
    cat > "$GLOBAL_CONF" << EOF
# --- OTTIMIZZAZIONI GLOBALI AMD RDNA 2 ---
# Documentazione: https://docs.mesa3d.org/envvars.html

# Attiva NGGC e SAM (Smart Access Memory)
export RADV_PERFTEST=nggc,sam

# Velocizza i giochi OpenGL (Multi-threading driver)
export mesa_glthread=true

# Forza il range di colori completo (Neri profondi su Samsung)
export VIDEO_KMS_FORCE_COLOR_RANGE=Full

# Gestione Cache Shader (Evita stuttering e ricompilazioni continue)
export MESA_SHADER_CACHE_DISABLE=false
export MESA_GLSL_CACHE_MAX_SIZE=4G
EOF
fi

# 2. IDENTIFICAZIONE GIOCO
REAL_PATH="${@: -1}"
FOLDER_NAME=$(basename "$(dirname "$REAL_PATH")")
CONF_FILE="$CONF_DIR/${FOLDER_NAME}.conf"

# 3. LOGICA DI CREAZIONE TEMPLATE (Manuale d'istruzioni integrato)
if [ ! -f "$CONF_FILE" ]; then
    cat > "$CONF_FILE" << EOF
# --- CONFIGURAZIONE PER: $FOLDER_NAME ---
# Riferimenti:
# - Gamescope: https://github.com/ValveSoftware/gamescope
# - Mesa/RADV: https://docs.mesa3d.org/envvars.html

# [LIMITER] Sincronizza gli FPS ai tuoi 120Hz (0=illimitati)
export GAMESCOPE_FPS_LIMIT=120

# [UPSCALING] FSR (0=Nitido, 20=Morbido). Attivo solo se -w < -W
# export GAMESCOPE_FILTER=fsr
# export GAMESCOPE_FSR_SHARPNESS=2

# [PERFORMANCE] Ray Tracing su RADV (Decommenta per attivare nei giochi compatibili)
# export RADV_PERFTEST=rt,nggc,sam

# [LATENZA] Riduce overhead pre-invio comandi GPU (Sperimentale)
# export RADV_DEBUG=preamble

# [VIDEO] Ottimizza i colori dei video/cutscenes compressi
export GAMESCOPE_NV12_COLORSPACE=1

# [LATENZA] Forza sincronia rigida se vedi tearing (linee orizzontali)
# export GAMESCOPE_DISABLE_ASYNC_FLIPS=1

# --- SEZIONE COMPATIBILITÃ€ (Fix per titoli specifici) ---

# [FIX] Disabilita NGGC se il gioco ha glitch grafici o crash
# export AMD_DEBUG=nonggc

# [FIX] Forza driver specifico (es: radeon_icd.i686 per giochi 32bit)
# export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/radeon_icd.x86_64.json
EOF
fi

# 4. CARICAMENTO
source "$GLOBAL_CONF"
source "$CONF_FILE"

# 5. LANCIO
echo "--- AVVIO: $FOLDER_NAME ($(date)) ---" > "$DEBUG_LOG"
echo "Conf caricato: $CONF_FILE" >> "$DEBUG_LOG"
"$@"
